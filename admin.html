<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Step up Team Manager - 管理者</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #0a0a0b;
      --bg-secondary: #141416;
      --bg-tertiary: #1c1c1f;
      --bg-card: #1a1a1d;
      --text-primary: #f5f5f7;
      --text-secondary: #a1a1a6;
      --text-tertiary: #6e6e73;
      --accent: #ff6b35;
      --accent-dim: rgba(255, 107, 53, 0.15);
      --border: #2c2c2e;
      --win: #34c759;
      --lose: #ff453a;
      --draw: #ff9f0a;
      --radius-sm: 6px;
      --radius-md: 10px;
      --radius-lg: 16px;
      --shadow: 0 4px 24px rgba(0, 0, 0, 0.4);
      --transition: all 0.2s ease;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Noto Sans JP', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.6;
      min-height: 100vh;
    }

    .auth-screen {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .auth-box {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 40px;
      width: 100%;
      max-width: 400px;
      text-align: center;
    }

    .auth-logo { font-size: 24px; font-weight: 700; margin-bottom: 8px; }
    .auth-logo span { color: var(--accent); }
    .auth-subtitle { color: var(--text-tertiary); font-size: 13px; margin-bottom: 32px; }

    .auth-input {
      width: 100%;
      padding: 14px 16px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text-primary);
      font-size: 14px;
      margin-bottom: 16px;
      text-align: center;
      letter-spacing: 4px;
    }

    .auth-input:focus { outline: none; border-color: var(--accent); }

    .auth-btn {
      width: 100%;
      padding: 14px;
      background: var(--accent);
      border: none;
      border-radius: var(--radius-sm);
      color: white;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition);
    }

    .auth-btn:hover { opacity: 0.9; }

    .auth-error {
      color: var(--lose);
      font-size: 13px;
      margin-top: 12px;
      display: none;
    }

    .admin-app { display: none; }
    .admin-app.active { display: flex; min-height: 100vh; }

    .sidebar {
      width: 240px;
      background: var(--bg-secondary);
      border-right: 1px solid var(--border);
      padding: 24px 0;
      position: fixed;
      height: 100vh;
      overflow-y: auto;
      z-index: 100;
    }

    .main { flex: 1; margin-left: 240px; min-height: 100vh; }
    .content { padding: 32px; max-width: 1200px; margin: 0 auto; }

    .logo { padding: 0 24px 24px; border-bottom: 1px solid var(--border); margin-bottom: 16px; }
    .logo h1 { font-size: 18px; font-weight: 700; }
    .logo span { color: var(--accent); }

    .logo-badge {
      display: inline-block;
      font-size: 9px;
      padding: 2px 6px;
      background: var(--accent);
      color: white;
      border-radius: 4px;
      margin-left: 8px;
      vertical-align: middle;
    }

    .nav-section { padding: 8px 12px; }

    .nav-section-title {
      font-size: 10px;
      font-weight: 500;
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: 1px;
      padding: 8px 12px 4px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      color: var(--text-secondary);
      text-decoration: none;
      border-radius: var(--radius-sm);
      font-size: 13px;
      cursor: pointer;
      transition: var(--transition);
    }

    .nav-item:hover { background: var(--bg-tertiary); color: var(--text-primary); }
    .nav-item.active { background: var(--accent-dim); color: var(--accent); }
    .nav-item svg { width: 18px; height: 18px; opacity: 0.7; }

    .page-header { margin-bottom: 32px; }
    .page-title { font-size: 28px; font-weight: 700; margin-bottom: 4px; }
    .page-subtitle { color: var(--text-secondary); font-size: 14px; }

    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 24px;
      margin-bottom: 20px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .card-title {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .form-group { margin-bottom: 20px; }

    .form-label {
      display: block;
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 6px;
      font-weight: 500;
    }

    .form-input, .form-select, .form-textarea {
      width: 100%;
      padding: 10px 14px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text-primary);
      font-size: 14px;
      font-family: inherit;
      transition: var(--transition);
    }

    .form-input:focus, .form-select:focus, .form-textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-dim);
    }

    .form-textarea { min-height: 100px; resize: vertical; }

    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 12px;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 10px 16px;
      border: none;
      border-radius: var(--radius-sm);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition);
      font-family: inherit;
    }

    .btn-primary { background: var(--accent); color: white; }
    .btn-primary:hover { opacity: 0.9; }

    .btn-secondary {
      background: var(--bg-tertiary);
      color: var(--text-primary);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover { background: var(--border); }

    .btn-danger {
      background: rgba(255, 69, 58, 0.15);
      color: var(--lose);
      border: 1px solid var(--lose);
    }

    .btn-sm { padding: 6px 12px; font-size: 12px; }

    .table-container { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; }

    th {
      text-align: left;
      font-size: 11px;
      font-weight: 500;
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
    }

    td {
      padding: 14px 16px;
      font-size: 14px;
      border-bottom: 1px solid var(--border);
      color: var(--text-secondary);
    }

    tr:hover td { background: var(--bg-tertiary); }

    .build-params {
      display: flex;
      gap: 6px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px;
    }

    .build-param {
      display: flex;
      align-items: center;
      gap: 3px;
      padding: 3px 6px;
      background: var(--bg-tertiary);
      border-radius: 4px;
    }

    .build-param-label { color: var(--text-tertiary); font-size: 9px; }
    .build-param-value { color: var(--accent); font-weight: 500; }

    .status-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
    }

    .status-active { background: rgba(52, 199, 89, 0.15); color: var(--win); }
    .status-inactive { background: rgba(255, 159, 10, 0.15); color: var(--draw); }
    .status-left { background: rgba(255, 69, 58, 0.15); color: var(--lose); }

    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: var(--transition);
    }

    .modal-overlay.active { opacity: 1; visibility: visible; }

    .modal {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 28px;
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      transform: translateY(20px);
      transition: transform 0.3s ease;
    }

    .modal-overlay.active .modal { transform: translateY(0); }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .modal-title { font-size: 18px; font-weight: 600; }

    .modal-close {
      background: none;
      border: none;
      color: var(--text-tertiary);
      cursor: pointer;
      padding: 4px;
    }

    .modal-close:hover { color: var(--text-primary); }

    .param-inputs {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
    }

    .param-input-group { text-align: center; }

    .param-input-group label {
      display: block;
      font-size: 11px;
      color: var(--text-tertiary);
      margin-bottom: 4px;
    }

    .param-input-group input {
      width: 100%;
      padding: 10px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text-primary);
      font-size: 18px;
      font-family: 'JetBrains Mono', monospace;
      text-align: center;
    }

    .param-total {
      text-align: center;
      margin-top: 12px;
      font-size: 14px;
    }

    .param-total span {
      font-family: 'JetBrains Mono', monospace;
      font-size: 20px;
      font-weight: 500;
    }

    .param-total.valid span { color: var(--win); }
    .param-total.invalid span { color: var(--lose); }

    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: 14px 20px;
      box-shadow: var(--shadow);
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.3s ease;
      z-index: 1001;
    }

    .toast.show { transform: translateY(0); opacity: 1; }
    .toast.success { border-color: var(--win); }
    .toast.error { border-color: var(--lose); }

    .page { display: none; }
    .page.active { display: block; }

    .empty-state {
      text-align: center;
      padding: 48px 24px;
      color: var(--text-tertiary);
    }

    .optional-fields {
      margin-top: 16px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
    }

    .optional-fields summary {
      padding: 12px 16px;
      cursor: pointer;
      color: var(--text-secondary);
      font-size: 13px;
      background: var(--bg-tertiary);
      border-radius: var(--radius-sm);
    }

    .optional-fields summary:hover {
      color: var(--text-primary);
    }

    .optional-fields[open] summary {
      border-radius: var(--radius-sm) var(--radius-sm) 0 0;
      border-bottom: 1px solid var(--border);
    }

    .optional-content {
      padding: 16px;
    }

    .checkbox-group {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: var(--transition);
      font-size: 13px;
    }

    .checkbox-item:hover {
      border-color: var(--accent);
    }

    .checkbox-item input[type="checkbox"] {
      accent-color: var(--accent);
      width: 16px;
      height: 16px;
      cursor: pointer;
    }

    .checkbox-item:has(input:checked) {
      background: var(--accent-dim);
      border-color: var(--accent);
    }

    .lineup-section {
      margin: 20px 0;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
    }

    .lineup-section summary {
      padding: 12px 16px;
      cursor: pointer;
      font-weight: 500;
      background: var(--bg-tertiary);
    }

    .lineup-section[open] summary {
      border-bottom: 1px solid var(--border);
    }

    .lineup-content {
      padding: 16px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    @media (max-width: 900px) {
      .lineup-content {
        grid-template-columns: 1fr;
      }
    }

    .lineup-team-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 12px;
      color: var(--accent);
    }

    .lineup-team-title.opponent {
      color: #ff6b6b;
    }

    .lineup-players {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .lineup-player {
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 12px;
    }

    .lineup-player-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .lineup-position {
      width: 24px;
      height: 24px;
      background: var(--accent);
      color: var(--bg-primary);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 600;
      flex-shrink: 0;
    }

    .lineup-player-select {
      flex: 1;
    }

    .lineup-params {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      margin-bottom: 8px;
    }

    .param-input {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .param-input label {
      font-size: 10px;
      color: var(--text-tertiary);
      text-align: center;
    }

    .param-input input {
      width: 100%;
      padding: 6px;
      text-align: center;
      font-size: 14px;
      font-weight: 500;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text-primary);
    }

    .lineup-build-select {
      font-size: 12px;
    }

    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px;
      color: var(--text-tertiary);
    }

    .spinner {
      width: 24px;
      height: 24px;
      border: 2px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-right: 12px;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    @media (max-width: 768px) {
      .sidebar { width: 100%; position: relative; height: auto; }
      .main { margin-left: 0; }
      .content { padding: 20px; }
      .admin-app.active { flex-direction: column; }
      .param-inputs { grid-template-columns: repeat(2, 1fr); }
    }
  </style>
</head>
<body>
  <!-- Auth Screen -->
  <div class="auth-screen" id="auth-screen">
    <div class="auth-box">
      <h1 class="auth-logo">Step <span>up</span></h1>
      <p class="auth-subtitle">管理者認証が必要です</p>
      <input type="password" class="auth-input" id="auth-password" placeholder="••••••••" onkeypress="if(event.key==='Enter')verifyPassword()">
      <button class="auth-btn" onclick="verifyPassword()">認証</button>
      <p class="auth-error" id="auth-error">パスワードが正しくありません</p>
    </div>
  </div>

  <!-- Admin App -->
  <div class="admin-app" id="admin-app">
    <aside class="sidebar">
      <div class="logo">
        <h1>Step <span>up</span> <span class="logo-badge">ADMIN</span></h1>
      </div>

      <nav class="nav-section">
        <div class="nav-section-title">選手管理</div>
        <a class="nav-item active" onclick="showPage('players')">
          <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
            <circle cx="9" cy="7" r="4"/>
          </svg>
          選手登録・編集
        </a>
        <a class="nav-item" onclick="showPage('builds')">
          <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <polygon points="12 2 2 7 12 12 22 7 12 2"/>
            <polyline points="2 17 12 22 22 17"/>
            <polyline points="2 12 12 17 22 12"/>
          </svg>
          ビルド管理
        </a>
      </nav>

      <nav class="nav-section">
        <div class="nav-section-title">試合管理</div>
        <a class="nav-item" onclick="showPage('matches')">
          <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
          </svg>
          試合登録
        </a>
        <a class="nav-item" onclick="showPage('tournaments')">
          <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
            <line x1="16" y1="2" x2="16" y2="6"/>
            <line x1="8" y1="2" x2="8" y2="6"/>
            <line x1="3" y1="10" x2="21" y2="10"/>
          </svg>
          大会管理
        </a>
      </nav>

      <nav class="nav-section">
        <div class="nav-section-title">対戦相手DB</div>
        <a class="nav-item" onclick="showPage('opponents')">
          <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
            <circle cx="9" cy="7" r="4"/>
            <line x1="19" y1="8" x2="19" y2="14"/>
            <line x1="22" y1="11" x2="16" y2="11"/>
          </svg>
          他チーム・選手
        </a>
      </nav>

      <nav class="nav-section" style="margin-top: auto; padding-top: 16px; border-top: 1px solid var(--border);">
        <a class="nav-item" href="index.html">
          <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M19 12H5"/>
            <polyline points="12 19 5 12 12 5"/>
          </svg>
          一般ページへ
        </a>
        <a class="nav-item" onclick="logout()">
          <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
            <polyline points="16 17 21 12 16 7"/>
            <line x1="21" y1="12" x2="9" y2="12"/>
          </svg>
          ログアウト
        </a>
      </nav>
    </aside>

    <main class="main">
      <div class="content">
        <!-- Players Page -->
        <div id="page-players" class="page active">
          <div class="page-header">
            <h2 class="page-title">選手管理</h2>
            <p class="page-subtitle">選手の登録・編集・ステータス変更</p>
          </div>

          <div class="card">
            <div class="card-header">
              <h3 class="card-title">選手一覧</h3>
              <button class="btn btn-primary btn-sm" onclick="openPlayerModal()">
                <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                  <line x1="12" y1="5" x2="12" y2="19"/>
                  <line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
                選手を追加
              </button>
            </div>
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>プレイヤーネーム</th>
                    <th>読み方</th>
                    <th>ポジション</th>
                    <th>ステータス</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody id="player-table"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Builds Page -->
        <div id="page-builds" class="page">
          <div class="page-header">
            <h2 class="page-title">ビルド管理</h2>
            <p class="page-subtitle">選手ごとのパラメータ設定</p>
          </div>

          <div class="card">
            <div class="card-header">
              <h3 class="card-title">選手を選択</h3>
            </div>
            <select class="form-select" id="build-player-select" onchange="loadPlayerBuilds()">
              <option value="">選手を選択してください</option>
            </select>
          </div>

          <div class="card" id="builds-section" style="display: none;">
            <div class="card-header">
              <h3 class="card-title">ビルド一覧</h3>
              <button class="btn btn-primary btn-sm" onclick="openBuildModal()">
                <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                  <line x1="12" y1="5" x2="12" y2="19"/>
                  <line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
                ビルドを追加
              </button>
            </div>
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>ビルド名</th>
                    <th>パラメータ</th>
                    <th>用途</th>
                    <th>使用頻度</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody id="build-table"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Matches Page -->
        <div id="page-matches" class="page">
          <div class="page-header">
            <h2 class="page-title">試合登録</h2>
            <p class="page-subtitle">試合結果と詳細の記録</p>
          </div>

          <div class="card">
            <div class="card-header">
              <h3 class="card-title">新規試合登録</h3>
            </div>
            <form id="match-form" onsubmit="submitMatch(event)">
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">日付</label>
                  <input type="date" class="form-input" name="date" required>
                </div>
                <div class="form-group">
                  <label class="form-label">大会</label>
                  <select class="form-select" name="tournamentId" id="match-tournament-select">
                    <option value="">練習試合</option>
                  </select>
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">対戦相手チーム</label>
                  <select class="form-select" name="opponentTeamId" id="match-opponent-select" onchange="loadOpponentPlayers()">
                    <option value="">選択してください</option>
                  </select>
                </div>
              </div>
              <div class="form-row">
                <div class="form-group">
                  <label class="form-label">自チームスコア</label>
                  <input type="number" class="form-input" name="ourScore" min="0" required>
                </div>
                <div class="form-group">
                  <label class="form-label">相手スコア</label>
                  <input type="number" class="form-input" name="opponentScore" min="0" required>
                </div>
              </div>
              
              <!-- 出場選手セクション -->
              <details class="lineup-section" open>
                <summary>出場選手・パラメータ</summary>
                <div class="lineup-content">
                  <!-- 自チーム選手 -->
                  <div class="lineup-team">
                    <h4 class="lineup-team-title">自チーム</h4>
                    <div class="lineup-players" id="our-lineup">
                      <div class="lineup-player" data-position="1">
                        <div class="lineup-player-header">
                          <span class="lineup-position">1</span>
                          <select class="form-select lineup-player-select" name="ourPlayer1" onchange="fillOurPlayerBuild(1)">
                            <option value="">選手を選択</option>
                          </select>
                        </div>
                        <div class="lineup-params">
                          <div class="param-input"><label>SPD</label><input type="number" name="ourPlayer1Spd" min="0" max="10" value="0"></div>
                          <div class="param-input"><label>SIZE</label><input type="number" name="ourPlayer1Size" min="0" max="10" value="0"></div>
                          <div class="param-input"><label>CHG</label><input type="number" name="ourPlayer1Chg" min="0" max="10" value="0"></div>
                          <div class="param-input"><label>SLD</label><input type="number" name="ourPlayer1Shield" min="0" max="10" value="0"></div>
                        </div>
                        <select class="form-select lineup-build-select" name="ourPlayer1Build" onchange="applyOurBuild(1)">
                          <option value="">ビルドから選択</option>
                        </select>
                      </div>
                      <div class="lineup-player" data-position="2">
                        <div class="lineup-player-header">
                          <span class="lineup-position">2</span>
                          <select class="form-select lineup-player-select" name="ourPlayer2" onchange="fillOurPlayerBuild(2)">
                            <option value="">選手を選択</option>
                          </select>
                        </div>
                        <div class="lineup-params">
                          <div class="param-input"><label>SPD</label><input type="number" name="ourPlayer2Spd" min="0" max="10" value="0"></div>
                          <div class="param-input"><label>SIZE</label><input type="number" name="ourPlayer2Size" min="0" max="10" value="0"></div>
                          <div class="param-input"><label>CHG</label><input type="number" name="ourPlayer2Chg" min="0" max="10" value="0"></div>
                          <div class="param-input"><label>SLD</label><input type="number" name="ourPlayer2Shield" min="0" max="10" value="0"></div>
                        </div>
                        <select class="form-select lineup-build-select" name="ourPlayer2Build" onchange="applyOurBuild(2)">
                          <option value="">ビルドから選択</option>
                        </select>
                      </div>
                      <div class="lineup-player" data-position="3">
                        <div class="lineup-player-header">
                          <span class="lineup-position">3</span>
                          <select class="form-select lineup-player-select" name="ourPlayer3" onchange="fillOurPlayerBuild(3)">
                            <option value="">選手を選択</option>
                          </select>
                        </div>
                        <div class="lineup-params">
                          <div class="param-input"><label>SPD</label><input type="number" name="ourPlayer3Spd" min="0" max="10" value="0"></div>
                          <div class="param-input"><label>SIZE</label><input type="number" name="ourPlayer3Size" min="0" max="10" value="0"></div>
                          <div class="param-input"><label>CHG</label><input type="number" name="ourPlayer3Chg" min="0" max="10" value="0"></div>
                          <div class="param-input"><label>SLD</label><input type="number" name="ourPlayer3Shield" min="0" max="10" value="0"></div>
                        </div>
                        <select class="form-select lineup-build-select" name="ourPlayer3Build" onchange="applyOurBuild(3)">
                          <option value="">ビルドから選択</option>
                        </select>
                      </div>
                    </div>
                  </div>
                  
                  <!-- 相手チーム選手 -->
                  <div class="lineup-team">
                    <h4 class="lineup-team-title opponent">相手チーム</h4>
                    <div class="lineup-players" id="opp-lineup">
                      <div class="lineup-player" data-position="1">
                        <div class="lineup-player-header">
                          <span class="lineup-position">1</span>
                          <select class="form-select lineup-player-select" name="oppPlayer1" onchange="fillOppPlayerBuild(1)">
                            <option value="">選手を選択</option>
                          </select>
                        </div>
                        <div class="lineup-params">
                          <div class="param-input"><label>SPD</label><input type="number" name="oppPlayer1Spd" min="0" max="10" value="0"></div>
                          <div class="param-input"><label>SIZE</label><input type="number" name="oppPlayer1Size" min="0" max="10" value="0"></div>
                          <div class="param-input"><label>CHG</label><input type="number" name="oppPlayer1Chg" min="0" max="10" value="0"></div>
                          <div class="param-input"><label>SLD</label><input type="number" name="oppPlayer1Shield" min="0" max="10" value="0"></div>
                        </div>
                        <select class="form-select lineup-build-select" name="oppPlayer1Build" onchange="applyOppBuild(1)">
                          <option value="">ビルドから選択</option>
                        </select>
                      </div>
                      <div class="lineup-player" data-position="2">
                        <div class="lineup-player-header">
                          <span class="lineup-position">2</span>
                          <select class="form-select lineup-player-select" name="oppPlayer2" onchange="fillOppPlayerBuild(2)">
                            <option value="">選手を選択</option>
                          </select>
                        </div>
                        <div class="lineup-params">
                          <div class="param-input"><label>SPD</label><input type="number" name="oppPlayer2Spd" min="0" max="10" value="0"></div>
                          <div class="param-input"><label>SIZE</label><input type="number" name="oppPlayer2Size" min="0" max="10" value="0"></div>
                          <div class="param-input"><label>CHG</label><input type="number" name="oppPlayer2Chg" min="0" max="10" value="0"></div>
                          <div class="param-input"><label>SLD</label><input type="number" name="oppPlayer2Shield" min="0" max="10" value="0"></div>
                        </div>
                        <select class="form-select lineup-build-select" name="oppPlayer2Build" onchange="applyOppBuild(2)">
                          <option value="">ビルドから選択</option>
                        </select>
                      </div>
                      <div class="lineup-player" data-position="3">
                        <div class="lineup-player-header">
                          <span class="lineup-position">3</span>
                          <select class="form-select lineup-player-select" name="oppPlayer3" onchange="fillOppPlayerBuild(3)">
                            <option value="">選手を選択</option>
                          </select>
                        </div>
                        <div class="lineup-params">
                          <div class="param-input"><label>SPD</label><input type="number" name="oppPlayer3Spd" min="0" max="10" value="0"></div>
                          <div class="param-input"><label>SIZE</label><input type="number" name="oppPlayer3Size" min="0" max="10" value="0"></div>
                          <div class="param-input"><label>CHG</label><input type="number" name="oppPlayer3Chg" min="0" max="10" value="0"></div>
                          <div class="param-input"><label>SLD</label><input type="number" name="oppPlayer3Shield" min="0" max="10" value="0"></div>
                        </div>
                        <select class="form-select lineup-build-select" name="oppPlayer3Build" onchange="applyOppBuild(3)">
                          <option value="">ビルドから選択</option>
                        </select>
                      </div>
                    </div>
                  </div>
                </div>
              </details>
              
              <div class="form-group">
                <label class="form-label">メモ</label>
                <textarea class="form-textarea" name="notes" placeholder="試合の概要や気づき"></textarea>
              </div>
              <button type="submit" class="btn btn-primary">試合を登録</button>
            </form>
          </div>

          <div class="card">
            <div class="card-header">
              <h3 class="card-title">登録済み試合</h3>
            </div>
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>日付</th>
                    <th>大会</th>
                    <th>対戦相手</th>
                    <th>スコア</th>
                    <th>結果</th>
                  </tr>
                </thead>
                <tbody id="match-table"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Tournaments Page -->
        <div id="page-tournaments" class="page">
          <div class="page-header">
            <h2 class="page-title">大会管理</h2>
            <p class="page-subtitle">大会の登録とエントリー管理</p>
          </div>

          <div class="card">
            <div class="card-header">
              <h3 class="card-title">大会一覧</h3>
              <button class="btn btn-primary btn-sm" onclick="openTournamentModal()">
                <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                  <line x1="12" y1="5" x2="12" y2="19"/>
                  <line x1="5" y1="12" x2="19" y2="12"/>
                </svg>
                大会を追加
              </button>
            </div>
            <div class="table-container">
              <table>
                <thead>
                  <tr>
                    <th>大会名</th>
                    <th>日付</th>
                    <th>グレード</th>
                    <th>状況</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody id="tournament-table"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Opponents Page -->
        <div id="page-opponents" class="page">
          <div class="page-header">
            <h2 class="page-title">対戦相手DB管理</h2>
            <p class="page-subtitle">他チーム・選手情報の登録</p>
          </div>

          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px;">
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">チーム一覧</h3>
                <button class="btn btn-primary btn-sm" onclick="openOtherTeamModal()">
                  <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <line x1="12" y1="5" x2="12" y2="19"/>
                    <line x1="5" y1="12" x2="19" y2="12"/>
                  </svg>
                  チームを追加
                </button>
              </div>
              <div class="table-container">
                <table>
                  <thead>
                    <tr>
                      <th>チーム名</th>
                      <th>地域</th>
                      <th>要注意</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody id="other-team-table"></tbody>
                </table>
              </div>
            </div>

            <div class="card">
              <div class="card-header">
                <h3 class="card-title">選手一覧</h3>
                <button class="btn btn-primary btn-sm" onclick="openOtherPlayerModal()">
                  <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <line x1="12" y1="5" x2="12" y2="19"/>
                    <line x1="5" y1="12" x2="19" y2="12"/>
                  </svg>
                  選手を追加
                </button>
              </div>
              <div class="table-container">
                <table>
                  <thead>
                    <tr>
                      <th>選手名</th>
                      <th>所属</th>
                      <th>ポジション</th>
                      <th></th>
                    </tr>
                  </thead>
                  <tbody id="other-player-table"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Player Modal -->
  <div class="modal-overlay" id="player-modal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="player-modal-title">選手を追加</h3>
        <button class="modal-close" onclick="closeModal('player-modal')">✕</button>
      </div>
      <form id="player-form" onsubmit="submitPlayer(event)">
        <input type="hidden" name="id">
        <div class="form-group">
          <label class="form-label">プレイヤーネーム *</label>
          <input type="text" class="form-input" name="nickname" required placeholder="ゲーム内で使用する名前">
        </div>
        <div class="form-group">
          <label class="form-label">読み方</label>
          <input type="text" class="form-input" name="furigana" placeholder="ひらがなで入力">
        </div>
        
        <details class="optional-fields">
          <summary>その他の情報（任意）</summary>
          <div class="optional-content">
            <div class="form-group">
              <label class="form-label">本名</label>
              <input type="text" class="form-input" name="name" placeholder="必要に応じて">
            </div>
            <div class="form-group">
              <label class="form-label">連絡先</label>
              <input type="text" class="form-input" name="contact" placeholder="LINE、Twitterなど">
            </div>
            <div class="form-group">
              <label class="form-label">ポジション（複数選択可）</label>
              <div class="checkbox-group" id="position-checkboxes">
                <label class="checkbox-item">
                  <input type="checkbox" name="position" value="アタッカー">
                  <span>アタッカー</span>
                </label>
                <label class="checkbox-item">
                  <input type="checkbox" name="position" value="サポーター">
                  <span>サポーター</span>
                </label>
                <label class="checkbox-item">
                  <input type="checkbox" name="position" value="タンク">
                  <span>タンク</span>
                </label>
                <label class="checkbox-item">
                  <input type="checkbox" name="position" value="サブタンク">
                  <span>サブタンク</span>
                </label>
                <label class="checkbox-item">
                  <input type="checkbox" name="position" value="チャージャー">
                  <span>チャージャー</span>
                </label>
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">ステータス</label>
              <select class="form-select" name="status">
                <option value="現役">現役</option>
                <option value="休止中">休止中</option>
                <option value="退団">退団</option>
              </select>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label class="form-label">加入日</label>
                <input type="date" class="form-input" name="joinDate">
              </div>
              <div class="form-group">
                <label class="form-label">退団日</label>
                <input type="date" class="form-input" name="leaveDate">
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">備考</label>
              <textarea class="form-textarea" name="notes" placeholder="メモなど"></textarea>
            </div>
          </div>
        </details>
        
        <button type="submit" class="btn btn-primary" style="width: 100%; margin-top: 20px;">保存</button>
      </form>
    </div>
  </div>

  <!-- Build Modal -->
  <div class="modal-overlay" id="build-modal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="build-modal-title">ビルドを追加</h3>
        <button class="modal-close" onclick="closeModal('build-modal')">✕</button>
      </div>
      <form id="build-form" onsubmit="submitBuild(event)">
        <input type="hidden" name="id">
        <input type="hidden" name="playerId">
        <div class="form-group">
          <label class="form-label">ビルド名 *</label>
          <input type="text" class="form-input" name="buildName" required placeholder="例: メイン、対アタッカー用">
        </div>
        <div class="form-group">
          <label class="form-label">パラメータ (合計10)</label>
          <div class="param-inputs">
            <div class="param-input-group">
              <label>SPD</label>
              <input type="number" name="spd" min="1" max="5" value="3" oninput="updateParamTotal()">
            </div>
            <div class="param-input-group">
              <label>SIZE</label>
              <input type="number" name="size" min="1" max="5" value="3" oninput="updateParamTotal()">
            </div>
            <div class="param-input-group">
              <label>CHG</label>
              <input type="number" name="chg" min="1" max="5" value="2" oninput="updateParamTotal()">
            </div>
            <div class="param-input-group">
              <label>SHIELD</label>
              <input type="number" name="shield" min="1" max="5" value="2" oninput="updateParamTotal()">
            </div>
          </div>
          <div class="param-total valid" id="param-total">合計: <span>10</span> / 10</div>
        </div>
        <div class="form-group">
          <label class="form-label">用途・使用場面</label>
          <input type="text" class="form-input" name="usage" placeholder="どんな相手・状況で使うか">
        </div>
        <div class="form-group">
          <label class="form-label">使用頻度</label>
          <select class="form-select" name="frequency">
            <option value="メイン">メイン</option>
            <option value="サブ">サブ</option>
            <option value="試験中">試験中</option>
          </select>
        </div>
        <button type="submit" class="btn btn-primary" style="width: 100%;">保存</button>
      </form>
    </div>
  </div>

  <!-- Tournament Modal -->
  <div class="modal-overlay" id="tournament-modal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">大会を追加</h3>
        <button class="modal-close" onclick="closeModal('tournament-modal')">✕</button>
      </div>
      <form id="tournament-form" onsubmit="submitTournament(event)">
        <input type="hidden" name="id">
        <div class="form-group">
          <label class="form-label">大会名 *</label>
          <input type="text" class="form-input" name="name" required>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">開催日</label>
            <input type="date" class="form-input" name="date">
          </div>
          <div class="form-group">
            <label class="form-label">エントリー締切</label>
            <input type="date" class="form-input" name="deadline">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">グレード</label>
            <select class="form-select" name="grade">
              <option value="WORLD CUP">WORLD CUP</option>
              <option value="GRAND SLAM">GRAND SLAM</option>
              <option value="500">500</option>
              <option value="200">200</option>
              <option value="80">80</option>
              <option value="OPEN" selected>OPEN</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">エントリー状況</label>
            <select class="form-select" name="entryStatus">
              <option value="未エントリー">未エントリー</option>
              <option value="エントリー済">エントリー済</option>
              <option value="不参加">不参加</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">出場予定メンバー</label>
          <input type="text" class="form-input" name="members" placeholder="カンマ区切り">
        </div>
        <button type="submit" class="btn btn-primary" style="width: 100%;">保存</button>
      </form>
    </div>
  </div>

  <!-- Other Team Modal -->
  <div class="modal-overlay" id="other-team-modal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">他チームを追加</h3>
        <button class="modal-close" onclick="closeModal('other-team-modal')">✕</button>
      </div>
      <form id="other-team-form" onsubmit="submitOtherTeam(event)">
        <input type="hidden" name="id">
        <div class="form-group">
          <label class="form-label">チーム名 *</label>
          <input type="text" class="form-input" name="name" required>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">地域</label>
            <input type="text" class="form-input" name="region" placeholder="関東、関西など">
          </div>
          <div class="form-group">
            <label class="form-label">要注意度</label>
            <select class="form-select" name="threat">
              <option value="★">★</option>
              <option value="★★" selected>★★</option>
              <option value="★★★">★★★</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">メモ</label>
          <textarea class="form-textarea" name="notes" placeholder="チームの特徴や対策"></textarea>
        </div>
        <button type="submit" class="btn btn-primary" style="width: 100%;">保存</button>
      </form>
    </div>
  </div>

  <!-- Other Player Modal -->
  <div class="modal-overlay" id="other-player-modal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">他チーム選手を追加</h3>
        <button class="modal-close" onclick="closeModal('other-player-modal')">✕</button>
      </div>
      <form id="other-player-form" onsubmit="submitOtherPlayer(event)">
        <input type="hidden" name="id">
        <div class="form-group">
          <label class="form-label">選手名 *</label>
          <input type="text" class="form-input" name="name" required>
        </div>
        <div class="form-group">
          <label class="form-label">所属チーム *</label>
          <select class="form-select" name="teamId" id="other-player-team-select" required>
            <option value="">選択してください</option>
          </select>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">ポジション</label>
            <select class="form-select" name="position">
              <option value="アタッカー">アタッカー</option>
              <option value="サポーター">サポーター</option>
              <option value="タンク">タンク</option>
              <option value="サブタンク">サブタンク</option>
              <option value="チャージャー">チャージャー</option>
              <option value="その他">その他</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">要注意度</label>
            <select class="form-select" name="threat">
              <option value="★">★</option>
              <option value="★★" selected>★★</option>
              <option value="★★★">★★★</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">過去所属チーム</label>
          <input type="text" class="form-input" name="pastTeams" placeholder="カンマ区切り">
        </div>
        <div class="form-group">
          <label class="form-label">プレイスタイル・メモ</label>
          <textarea class="form-textarea" name="playStyle" placeholder="特徴や対策"></textarea>
        </div>
        <button type="submit" class="btn btn-primary" style="width: 100%;">保存</button>
      </form>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbyJ25BrsrLxY01cXqriuyeO8YgqpumOq9_sTuw88Knr9CcIdzfzSIi-NMIMAhdtue3R/exec';

    let state = {
      players: [],
      builds: [],
      otherTeams: [],
      otherPlayers: [],
      matches: [],
      tournaments: []
    };

    // ===== JSONP API =====
    let callbackCounter = 0;
    
    function api(action, data = {}) {
      return new Promise((resolve, reject) => {
        const callbackName = 'jsonpCallback_' + (++callbackCounter) + '_' + Date.now();
        const script = document.createElement('script');
        
        window[callbackName] = function(response) {
          delete window[callbackName];
          document.body.removeChild(script);
          resolve(response);
        };
        
        const params = new URLSearchParams({
          callback: callbackName,
          action: action,
          data: encodeURIComponent(JSON.stringify(data))
        });
        
        script.src = API_URL + '?' + params.toString();
        script.onerror = () => {
          delete window[callbackName];
          document.body.removeChild(script);
          reject(new Error('Network error'));
        };
        
        document.body.appendChild(script);
      });
    }

    // ===== Auth =====
    async function verifyPassword() {
      const password = document.getElementById('auth-password').value;
      try {
        const result = await api('verifyAdmin', { password });
        
        if (result.success) {
          document.getElementById('auth-screen').style.display = 'none';
          document.getElementById('admin-app').classList.add('active');
          sessionStorage.setItem('adminAuth', 'true');
          loadPlayers();
        } else {
          document.getElementById('auth-error').style.display = 'block';
        }
      } catch (error) {
        showToast('通信エラーが発生しました', 'error');
      }
    }

    function logout() {
      sessionStorage.removeItem('adminAuth');
      location.reload();
    }

    if (sessionStorage.getItem('adminAuth') === 'true') {
      document.getElementById('auth-screen').style.display = 'none';
      document.getElementById('admin-app').classList.add('active');
    }

    // ===== UI =====
    function showPage(pageId) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById('page-' + pageId).classList.add('active');
      
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      if (event && event.target) {
        event.target.closest('.nav-item').classList.add('active');
      }
      
      switch(pageId) {
        case 'players': loadPlayers(); break;
        case 'builds': loadBuildsPage(); break;
        case 'matches': loadMatchesPage(); break;
        case 'tournaments': loadTournaments(); break;
        case 'opponents': loadOpponents(); break;
      }
    }

    function showToast(message, type = 'success') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = 'toast ' + type + ' show';
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    function openModal(id) { document.getElementById(id).classList.add('active'); }
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }

    // ===== Players =====
    async function loadPlayers() {
      try {
        state.players = await api('getTeamPlayers');
        renderPlayerTable();
      } catch (error) {
        showToast('データの読み込みに失敗しました', 'error');
      }
    }

    function renderPlayerTable() {
      const tbody = document.getElementById('player-table');
      if (state.players.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="empty-state">選手が登録されていません</td></tr>';
        return;
      }
      
      tbody.innerHTML = state.players.map(p => `
        <tr>
          <td style="font-weight: 500;">${p.nickname || p.name || '-'}</td>
          <td style="color: var(--text-tertiary);">${p.furigana || '-'}</td>
          <td>${p.position || '未設定'}</td>
          <td>
            <span class="status-badge ${p.status === '現役' ? 'status-active' : p.status === '休止中' ? 'status-inactive' : 'status-left'}">${p.status || '現役'}</span>
          </td>
          <td>
            <button class="btn btn-secondary btn-sm" onclick="editPlayer('${p.id}')">編集</button>
            <button class="btn btn-danger btn-sm" onclick="deletePlayer('${p.id}', '${(p.nickname || p.name || '').replace(/'/g, "\\'")}')">削除</button>
          </td>
        </tr>
      `).join('');
    }

    function openPlayerModal() {
      document.getElementById('player-modal-title').textContent = '選手を追加';
      document.getElementById('player-form').reset();
      // チェックボックスをリセット
      document.querySelectorAll('#position-checkboxes input[type="checkbox"]').forEach(cb => cb.checked = false);
      openModal('player-modal');
    }

    function editPlayer(id) {
      const player = state.players.find(p => p.id === id);
      if (!player) return;
      
      document.getElementById('player-modal-title').textContent = '選手を編集';
      const form = document.getElementById('player-form');
      form.id.value = player.id;
      form.nickname.value = player.nickname || '';
      form.furigana.value = player.furigana || '';
      form.name.value = player.name || '';
      form.contact.value = player.contact || '';
      form.status.value = player.status || '現役';
      form.joinDate.value = player.joinDate ? player.joinDate.split('T')[0] : '';
      form.leaveDate.value = player.leaveDate ? player.leaveDate.split('T')[0] : '';
      form.notes.value = player.notes || '';
      
      // ポジションのチェックボックスを設定
      const positions = (player.position || '').split('/').map(p => p.trim());
      document.querySelectorAll('#position-checkboxes input[type="checkbox"]').forEach(cb => {
        cb.checked = positions.includes(cb.value);
      });
      
      openModal('player-modal');
    }

    async function submitPlayer(e) {
      e.preventDefault();
      const form = e.target;
      
      // 選択されたポジションを取得
      const selectedPositions = [];
      document.querySelectorAll('#position-checkboxes input[type="checkbox"]:checked').forEach(cb => {
        selectedPositions.push(cb.value);
      });
      const positionStr = selectedPositions.length > 0 ? selectedPositions.join('/') : '未設定';
      
      const data = {
        id: form.id.value,
        nickname: form.nickname.value,
        furigana: form.furigana.value,
        name: form.name.value,
        contact: form.contact.value,
        position: positionStr,
        status: form.status.value || '現役',
        joinDate: form.joinDate.value,
        leaveDate: form.leaveDate.value,
        notes: form.notes.value
      };
      
      try {
        const action = data.id ? 'updateTeamPlayer' : 'addTeamPlayer';
        const result = await api(action, { player: data });
        
        if (result.success) {
          showToast(data.id ? '選手を更新しました' : '選手を追加しました');
          closeModal('player-modal');
          loadPlayers();
        } else {
          showToast(result.error || 'エラーが発生しました', 'error');
        }
      } catch (error) {
        showToast('通信エラーが発生しました', 'error');
      }
    }

    async function deletePlayer(id, name) {
      if (!confirm(`「${name}」を削除しますか？\nこの操作は取り消せません。`)) return;
      
      try {
        const result = await api('deleteTeamPlayer', { playerId: id });
        if (result.success) {
          showToast('選手を削除しました');
          loadPlayers();
        } else {
          showToast(result.error || 'エラーが発生しました', 'error');
        }
      } catch (error) {
        showToast('通信エラーが発生しました', 'error');
      }
    }

    // ===== Builds =====
    async function loadBuildsPage() {
      try {
        state.players = await api('getTeamPlayers');
        const select = document.getElementById('build-player-select');
        select.innerHTML = '<option value="">選手を選択してください</option>' +
          state.players.filter(p => p.status === '現役' || !p.status).map(p => 
            `<option value="${p.id}">${p.nickname || p.name || '名前未設定'}</option>`
          ).join('');
      } catch (error) {
        showToast('データの読み込みに失敗しました', 'error');
      }
    }

    async function loadPlayerBuilds() {
      const playerId = document.getElementById('build-player-select').value;
      if (!playerId) {
        document.getElementById('builds-section').style.display = 'none';
        return;
      }
      
      try {
        state.builds = await api('getTeamBuilds', { playerId });
        document.getElementById('builds-section').style.display = 'block';
        renderBuildTable();
      } catch (error) {
        showToast('データの読み込みに失敗しました', 'error');
      }
    }

    function renderBuildTable() {
      const tbody = document.getElementById('build-table');
      if (state.builds.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="empty-state">ビルドが登録されていません</td></tr>';
        return;
      }
      
      tbody.innerHTML = state.builds.map(b => `
        <tr>
          <td style="font-weight: 500;">${b.buildName}</td>
          <td>
            <div class="build-params">
              <div class="build-param"><span class="build-param-label">SPD</span><span class="build-param-value">${b.spd}</span></div>
              <div class="build-param"><span class="build-param-label">SIZE</span><span class="build-param-value">${b.size}</span></div>
              <div class="build-param"><span class="build-param-label">CHG</span><span class="build-param-value">${b.chg}</span></div>
              <div class="build-param"><span class="build-param-label">SLD</span><span class="build-param-value">${b.shield}</span></div>
            </div>
          </td>
          <td style="font-size: 12px; color: var(--text-tertiary);">${b.usage || '-'}</td>
          <td>${b.frequency}</td>
          <td>
            <button class="btn btn-secondary btn-sm" onclick="editBuild('${b.id}')">編集</button>
            <button class="btn btn-danger btn-sm" onclick="deleteBuild('${b.id}')">削除</button>
          </td>
        </tr>
      `).join('');
    }

    function openBuildModal() {
      const playerId = document.getElementById('build-player-select').value;
      if (!playerId) {
        showToast('選手を選択してください', 'error');
        return;
      }
      
      document.getElementById('build-modal-title').textContent = 'ビルドを追加';
      const form = document.getElementById('build-form');
      form.reset();
      form.playerId.value = playerId;
      form.spd.value = 3;
      form.size.value = 3;
      form.chg.value = 2;
      form.shield.value = 2;
      updateParamTotal();
      openModal('build-modal');
    }

    function editBuild(id) {
      const build = state.builds.find(b => b.id === id);
      if (!build) return;
      
      document.getElementById('build-modal-title').textContent = 'ビルドを編集';
      const form = document.getElementById('build-form');
      form.id.value = build.id;
      form.playerId.value = build.playerId;
      form.buildName.value = build.buildName;
      form.spd.value = build.spd;
      form.size.value = build.size;
      form.chg.value = build.chg;
      form.shield.value = build.shield;
      form.usage.value = build.usage || '';
      form.frequency.value = build.frequency;
      updateParamTotal();
      openModal('build-modal');
    }

    function updateParamTotal() {
      const form = document.getElementById('build-form');
      const total = Number(form.spd.value) + Number(form.size.value) + Number(form.chg.value) + Number(form.shield.value);
      const div = document.getElementById('param-total');
      div.querySelector('span').textContent = total;
      div.className = 'param-total ' + (total === 10 ? 'valid' : 'invalid');
    }

    async function submitBuild(e) {
      e.preventDefault();
      const form = e.target;
      const data = {
        id: form.id.value,
        playerId: form.playerId.value,
        buildName: form.buildName.value,
        spd: Number(form.spd.value),
        size: Number(form.size.value),
        chg: Number(form.chg.value),
        shield: Number(form.shield.value),
        usage: form.usage.value,
        frequency: form.frequency.value
      };
      
      try {
        const action = data.id ? 'updateTeamBuild' : 'addTeamBuild';
        const result = await api(action, { build: data });
        
        if (result.success) {
          showToast(data.id ? 'ビルドを更新しました' : 'ビルドを追加しました');
          closeModal('build-modal');
          loadPlayerBuilds();
        } else {
          showToast(result.error || 'エラーが発生しました', 'error');
        }
      } catch (error) {
        showToast('通信エラーが発生しました', 'error');
      }
    }

    async function deleteBuild(id) {
      if (!confirm('このビルドを削除しますか？')) return;
      
      try {
        const result = await api('deleteTeamBuild', { buildId: id });
        if (result.success) {
          showToast('ビルドを削除しました');
          loadPlayerBuilds();
        } else {
          showToast(result.error || 'エラーが発生しました', 'error');
        }
      } catch (error) {
        showToast('通信エラーが発生しました', 'error');
      }
    }

    // ===== Matches =====
    async function loadMatchesPage() {
      try {
        state.tournaments = await api('getTournaments');
        state.otherTeams = await api('getOtherTeams');
        state.matches = await api('getMatches');
        state.players = await api('getTeamPlayers');
        state.builds = await api('getTeamBuilds');
        
        const tournamentSelect = document.getElementById('match-tournament-select');
        tournamentSelect.innerHTML = '<option value="">練習試合</option>' +
          state.tournaments.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
        
        const opponentSelect = document.getElementById('match-opponent-select');
        opponentSelect.innerHTML = '<option value="">選択してください</option>' +
          state.otherTeams.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
        
        // 自チーム選手のドロップダウンを初期化
        const activePlayers = state.players.filter(p => !p.status || p.status === '現役');
        const playerOptions = '<option value="">選手を選択</option>' +
          activePlayers.map(p => `<option value="${p.id}">${p.nickname || p.name}</option>`).join('');
        
        document.querySelectorAll('#our-lineup .lineup-player-select').forEach(select => {
          select.innerHTML = playerOptions;
        });
        
        // 相手チーム選手のドロップダウンをリセット
        document.querySelectorAll('#opp-lineup .lineup-player-select').forEach(select => {
          select.innerHTML = '<option value="">選手を選択</option>';
        });
        
        // ビルドのドロップダウンをリセット
        document.querySelectorAll('.lineup-build-select').forEach(select => {
          select.innerHTML = '<option value="">ビルドから選択</option>';
        });
        
        renderMatchTable();
      } catch (error) {
        showToast('データの読み込みに失敗しました', 'error');
      }
    }

    // 相手チーム選択時に相手選手を読み込む
    async function loadOpponentPlayers() {
      const teamId = document.getElementById('match-opponent-select').value;
      if (!teamId) {
        document.querySelectorAll('#opp-lineup .lineup-player-select').forEach(select => {
          select.innerHTML = '<option value="">選手を選択</option>';
        });
        return;
      }
      
      try {
        state.oppPlayers = await api('getOtherPlayers', { teamId: teamId });
        state.oppBuilds = await api('getOtherBuilds');
        
        const playerOptions = '<option value="">選手を選択</option>' +
          '<option value="__new__">＋ 新規選手を入力</option>' +
          state.oppPlayers.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
        
        document.querySelectorAll('#opp-lineup .lineup-player-select').forEach(select => {
          select.innerHTML = playerOptions;
        });
      } catch (error) {
        showToast('相手選手の読み込みに失敗しました', 'error');
      }
    }

    // 自チーム選手選択時にビルドを読み込む
    function fillOurPlayerBuild(position) {
      const select = document.querySelector(`[name="ourPlayer${position}"]`);
      const buildSelect = document.querySelector(`[name="ourPlayer${position}Build"]`);
      const playerId = select.value;
      
      if (!playerId) {
        buildSelect.innerHTML = '<option value="">ビルドから選択</option>';
        return;
      }
      
      const playerBuilds = state.builds.filter(b => b.playerId === playerId);
      buildSelect.innerHTML = '<option value="">ビルドから選択</option>' +
        playerBuilds.map(b => `<option value="${b.id}" data-spd="${b.spd}" data-size="${b.size}" data-chg="${b.chg}" data-shield="${b.shield}">${b.buildName} (${b.spd}/${b.size}/${b.chg}/${b.shield})</option>`).join('');
    }

    // 自チームビルド選択時にパラメータを適用
    function applyOurBuild(position) {
      const buildSelect = document.querySelector(`[name="ourPlayer${position}Build"]`);
      const selectedOption = buildSelect.selectedOptions[0];
      
      if (selectedOption && selectedOption.value) {
        document.querySelector(`[name="ourPlayer${position}Spd"]`).value = selectedOption.dataset.spd || 0;
        document.querySelector(`[name="ourPlayer${position}Size"]`).value = selectedOption.dataset.size || 0;
        document.querySelector(`[name="ourPlayer${position}Chg"]`).value = selectedOption.dataset.chg || 0;
        document.querySelector(`[name="ourPlayer${position}Shield"]`).value = selectedOption.dataset.shield || 0;
      }
    }

    // 相手選手選択時にビルドを読み込む
    function fillOppPlayerBuild(position) {
      const select = document.querySelector(`[name="oppPlayer${position}"]`);
      const buildSelect = document.querySelector(`[name="oppPlayer${position}Build"]`);
      const playerId = select.value;
      
      if (!playerId || playerId === '__new__') {
        buildSelect.innerHTML = '<option value="">ビルドから選択</option>';
        return;
      }
      
      const playerBuilds = (state.oppBuilds || []).filter(b => b.playerId === playerId);
      buildSelect.innerHTML = '<option value="">ビルドから選択</option>' +
        playerBuilds.map(b => `<option value="${b.id}" data-spd="${b.spd}" data-size="${b.size}" data-chg="${b.chg}" data-shield="${b.shield}">${b.buildName} (${b.spd}/${b.size}/${b.chg}/${b.shield})</option>`).join('');
    }

    // 相手ビルド選択時にパラメータを適用
    function applyOppBuild(position) {
      const buildSelect = document.querySelector(`[name="oppPlayer${position}Build"]`);
      const selectedOption = buildSelect.selectedOptions[0];
      
      if (selectedOption && selectedOption.value) {
        document.querySelector(`[name="oppPlayer${position}Spd"]`).value = selectedOption.dataset.spd || 0;
        document.querySelector(`[name="oppPlayer${position}Size"]`).value = selectedOption.dataset.size || 0;
        document.querySelector(`[name="oppPlayer${position}Chg"]`).value = selectedOption.dataset.chg || 0;
        document.querySelector(`[name="oppPlayer${position}Shield"]`).value = selectedOption.dataset.shield || 0;
      }
    }

    function renderMatchTable() {
      const tbody = document.getElementById('match-table');
      if (state.matches.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="empty-state">試合が登録されていません</td></tr>';
        return;
      }
      
      tbody.innerHTML = state.matches.slice(0, 20).map(m => `
        <tr>
          <td>${formatDate(m.date)}</td>
          <td>${m.tournamentName || '練習試合'}</td>
          <td>${m.opponentTeamName || '-'}</td>
          <td style="font-family: 'JetBrains Mono', monospace;">${m.ourScore} - ${m.opponentScore}</td>
          <td>
            <span class="status-badge ${m.result === '勝ち' ? 'status-active' : m.result === '負け' ? 'status-left' : 'status-inactive'}">${m.result}</span>
          </td>
        </tr>
      `).join('');
    }

    async function submitMatch(e) {
      e.preventDefault();
      const form = e.target;
      
      const tournament = state.tournaments.find(t => t.id === form.tournamentId.value);
      const opponent = state.otherTeams.find(t => t.id === form.opponentTeamId.value);
      
      const matchData = {
        date: form.date.value,
        tournamentId: form.tournamentId.value,
        tournamentName: tournament ? tournament.name : '',
        opponentTeamId: form.opponentTeamId.value,
        opponentTeamName: opponent ? opponent.name : '',
        ourScore: Number(form.ourScore.value),
        opponentScore: Number(form.opponentScore.value),
        notes: form.notes.value
      };
      
      try {
        // 試合を登録
        const result = await api('addMatch', { match: matchData });
        if (!result.success) {
          showToast(result.error || 'エラーが発生しました', 'error');
          return;
        }
        
        const matchId = result.id;
        
        // 出場選手データを収集
        const lineups = [];
        
        // 自チーム選手
        for (let i = 1; i <= 3; i++) {
          const playerId = form[`ourPlayer${i}`].value;
          if (playerId) {
            const player = state.players.find(p => p.id === playerId);
            lineups.push({
              team: 'self',
              position: i,
              playerId: playerId,
              playerName: player ? (player.nickname || player.name) : '',
              spd: Number(form[`ourPlayer${i}Spd`].value) || 0,
              size: Number(form[`ourPlayer${i}Size`].value) || 0,
              chg: Number(form[`ourPlayer${i}Chg`].value) || 0,
              shield: Number(form[`ourPlayer${i}Shield`].value) || 0
            });
          }
        }
        
        // 相手チーム選手
        for (let i = 1; i <= 3; i++) {
          const playerId = form[`oppPlayer${i}`].value;
          const playerSelect = form[`oppPlayer${i}`];
          const playerName = playerSelect.selectedOptions[0]?.text || '';
          
          if (playerId && playerId !== '__new__') {
            const player = (state.oppPlayers || []).find(p => p.id === playerId);
            lineups.push({
              team: 'opponent',
              position: i,
              playerId: playerId,
              playerName: player ? player.name : playerName,
              spd: Number(form[`oppPlayer${i}Spd`].value) || 0,
              size: Number(form[`oppPlayer${i}Size`].value) || 0,
              chg: Number(form[`oppPlayer${i}Chg`].value) || 0,
              shield: Number(form[`oppPlayer${i}Shield`].value) || 0
            });
          }
        }
        
        // 出場選手を登録
        if (lineups.length > 0) {
          await api('addMatchLineups', { matchId: matchId, lineups: lineups });
        }
        
        showToast('試合を登録しました');
        form.reset();
        loadMatchesPage();
      } catch (error) {
        showToast('通信エラーが発生しました', 'error');
      }
    }

    // ===== Tournaments =====
    async function loadTournaments() {
      try {
        state.tournaments = await api('getTournaments');
        renderTournamentTable();
      } catch (error) {
        showToast('データの読み込みに失敗しました', 'error');
      }
    }

    function renderTournamentTable() {
      const tbody = document.getElementById('tournament-table');
      if (state.tournaments.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="empty-state">大会が登録されていません</td></tr>';
        return;
      }
      
      tbody.innerHTML = state.tournaments.map(t => `
        <tr>
          <td style="font-weight: 500;">${t.name}</td>
          <td>${formatDate(t.date)}</td>
          <td>${t.grade}</td>
          <td>
            <span class="status-badge ${t.entryStatus === 'エントリー済' ? 'status-active' : t.entryStatus === '不参加' ? 'status-left' : ''}">${t.entryStatus}</span>
          </td>
          <td><button class="btn btn-secondary btn-sm" onclick="editTournament('${t.id}')">編集</button></td>
        </tr>
      `).join('');
    }

    function openTournamentModal() {
      document.getElementById('tournament-form').reset();
      openModal('tournament-modal');
    }

    function editTournament(id) {
      const tournament = state.tournaments.find(t => t.id === id);
      if (!tournament) return;
      
      const form = document.getElementById('tournament-form');
      form.id.value = tournament.id;
      form.name.value = tournament.name;
      form.date.value = tournament.date ? tournament.date.split('T')[0] : '';
      form.deadline.value = tournament.deadline ? tournament.deadline.split('T')[0] : '';
      form.grade.value = tournament.grade;
      form.entryStatus.value = tournament.entryStatus;
      form.members.value = tournament.members || '';
      
      openModal('tournament-modal');
    }

    async function submitTournament(e) {
      e.preventDefault();
      const form = e.target;
      const data = {
        id: form.id.value,
        name: form.name.value,
        date: form.date.value,
        deadline: form.deadline.value,
        grade: form.grade.value,
        entryStatus: form.entryStatus.value,
        members: form.members.value
      };
      
      try {
        const action = data.id ? 'updateTournament' : 'addTournament';
        const result = await api(action, { tournament: data });
        
        if (result.success) {
          showToast(data.id ? '大会を更新しました' : '大会を追加しました');
          closeModal('tournament-modal');
          loadTournaments();
        } else {
          showToast(result.error || 'エラーが発生しました', 'error');
        }
      } catch (error) {
        showToast('通信エラーが発生しました', 'error');
      }
    }

    // ===== Opponents =====
    async function loadOpponents() {
      try {
        state.otherTeams = await api('getOtherTeams');
        state.otherPlayers = await api('getOtherPlayers');
        renderOtherTeamTable();
        renderOtherPlayerTable();
        updateOtherPlayerTeamSelect();
      } catch (error) {
        showToast('データの読み込みに失敗しました', 'error');
      }
    }

    function renderOtherTeamTable() {
      const tbody = document.getElementById('other-team-table');
      if (state.otherTeams.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="empty-state">チームが登録されていません</td></tr>';
        return;
      }
      
      tbody.innerHTML = state.otherTeams.map(t => `
        <tr>
          <td style="font-weight: 500;">${t.name}</td>
          <td>${t.region || '-'}</td>
          <td style="color: var(--draw);">${t.threat}</td>
          <td><button class="btn btn-secondary btn-sm" onclick="editOtherTeam('${t.id}')">編集</button></td>
        </tr>
      `).join('');
    }

    function renderOtherPlayerTable() {
      const tbody = document.getElementById('other-player-table');
      if (state.otherPlayers.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="empty-state">選手が登録されていません</td></tr>';
        return;
      }
      
      tbody.innerHTML = state.otherPlayers.map(p => {
        const team = state.otherTeams.find(t => t.id === p.teamId);
        return `
          <tr>
            <td style="font-weight: 500;">${p.name}</td>
            <td>${team ? team.name : '-'}</td>
            <td>${p.position}</td>
            <td><button class="btn btn-secondary btn-sm" onclick="editOtherPlayer('${p.id}')">編集</button></td>
          </tr>
        `;
      }).join('');
    }

    function updateOtherPlayerTeamSelect() {
      const select = document.getElementById('other-player-team-select');
      select.innerHTML = '<option value="">選択してください</option>' +
        state.otherTeams.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
    }

    function openOtherTeamModal() {
      document.getElementById('other-team-form').reset();
      openModal('other-team-modal');
    }

    function editOtherTeam(id) {
      const team = state.otherTeams.find(t => t.id === id);
      if (!team) return;
      
      const form = document.getElementById('other-team-form');
      form.id.value = team.id;
      form.name.value = team.name;
      form.region.value = team.region || '';
      form.threat.value = team.threat;
      form.notes.value = team.notes || '';
      
      openModal('other-team-modal');
    }

    async function submitOtherTeam(e) {
      e.preventDefault();
      const form = e.target;
      const data = {
        id: form.id.value,
        name: form.name.value,
        region: form.region.value,
        threat: form.threat.value,
        notes: form.notes.value
      };
      
      try {
        const action = data.id ? 'updateOtherTeam' : 'addOtherTeam';
        const result = await api(action, { team: data });
        
        if (result.success) {
          showToast(data.id ? 'チームを更新しました' : 'チームを追加しました');
          closeModal('other-team-modal');
          loadOpponents();
        } else {
          showToast(result.error || 'エラーが発生しました', 'error');
        }
      } catch (error) {
        showToast('通信エラーが発生しました', 'error');
      }
    }

    function openOtherPlayerModal() {
      document.getElementById('other-player-form').reset();
      openModal('other-player-modal');
    }

    function editOtherPlayer(id) {
      const player = state.otherPlayers.find(p => p.id === id);
      if (!player) return;
      
      const form = document.getElementById('other-player-form');
      form.id.value = player.id;
      form.name.value = player.name;
      form.teamId.value = player.teamId;
      form.position.value = player.position;
      form.threat.value = player.threat;
      form.pastTeams.value = player.pastTeams || '';
      form.playStyle.value = player.playStyle || '';
      
      openModal('other-player-modal');
    }

    async function submitOtherPlayer(e) {
      e.preventDefault();
      const form = e.target;
      const data = {
        id: form.id.value,
        name: form.name.value,
        teamId: form.teamId.value,
        position: form.position.value,
        threat: form.threat.value,
        pastTeams: form.pastTeams.value,
        playStyle: form.playStyle.value
      };
      
      try {
        const action = data.id ? 'updateOtherPlayer' : 'addOtherPlayer';
        const result = await api(action, { player: data });
        
        if (result.success) {
          showToast(data.id ? '選手を更新しました' : '選手を追加しました');
          closeModal('other-player-modal');
          loadOpponents();
        } else {
          showToast(result.error || 'エラーが発生しました', 'error');
        }
      } catch (error) {
        showToast('通信エラーが発生しました', 'error');
      }
    }

    // ===== Utilities =====
    function formatDate(dateStr) {
      if (!dateStr) return '-';
      const date = new Date(dateStr);
      return `${date.getFullYear()}/${String(date.getMonth() + 1).padStart(2, '0')}/${String(date.getDate()).padStart(2, '0')}`;
    }

    // Init
    document.addEventListener('DOMContentLoaded', () => {
      if (sessionStorage.getItem('adminAuth') === 'true') {
        loadPlayers();
      }
    });
  </script>
</body>
</html>
